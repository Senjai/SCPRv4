<% if !@date %>
	<h1><%= page_title "Archive" %></h1>
<% else %>

<% date_is_today = @date == Time.now.beginning_of_day %>

<h1><%= page_title "Archive for #{format_date @date, format: :full_date}" %></h1>

<nav class="filters">
	<ul class="clearfix" id="archive_nav">
		<li class="heading">View:</li>
		<li class="active"><a href="#news" data-toggle="tab">News</a></li>
		<li><a href="#blogs" data-toggle="tab">Blogs</a></li>
		<li><a href="#video" data-toggle="tab">Video</a></li>
		<li><a href="#programs" data-toggle="tab">Programs</a></li>		
	</ul>
</nav>

<div class="tab-content">
	
<!-- News Stories -->
<div id="news" class="tab-pane active">
<%= content_cache "archive:#{@date.to_i}:news_stories" do %>
	<h2>News</h2>
	
	<%= any_to_list? @news_stories + @content_shells, message: "There was no News published on this date." do %>
		<% (@news_stories + @content_shells).each do |content| %>
			<% register_content content %>
	
			<div class="teaser cbase">
				<div class="row-fluid">
					<% if content.assets.present? %>
						<div class="span4">
							<%= render_asset content, 'thumb' %>
						</div>
						<div class="span20">
					<% else %>
						<div class="span24">
					<% end %>
						<div class="info">
							<h3><%= link_to content.short_headline, content.link_path %></h3>
							<p class="byline">
								<% if content.category.present? %>
									<span class="categories"><%= link_to content.category.category, section_path(content.category.slug) %></span> 
									<span class="pipe">|</span> 
								<% end %>
								<time pubdate=""><%= content.published_at.strftime("%l:%M%P") %></time> 
								<span class="pipe">|</span> 
								<%= render_byline content %>
							</p>
							<%= content.teaser %>
						</div>
					</div> <!-- span18/24 -->
				</div>
			</div>
		<% end %>
	<% end %>
<% end %>
</div>
<!-- /news-stories -->


<!-- Blog Entries -->
<div id="blogs" class="tab-pane">
<%= content_cache "archive:#{@date.to_i}:blog_entries" do %>
	<h2>Blogs</h2>
	
	<%= any_to_list? @blog_entries, message: "There were no blog entries published on this date." do %>
		<% @blog_entries.each do |content| %>
			<% register_content(content) if @date == Time.now.beginning_of_day %>
		
			<div class="teaser cbase">
				<div class="row-fluid">
					<% if content.assets.present? %>
						<div class="span4">
							<%= render_asset content, 'thumb' %>
						</div>
						<div class="span20">
					<% else %>
						<div class="span24">
					<% end %>
						<div class="info">
							<h3><%= link_to content.short_headline, content.link_path %></h3>
							<p class="byline">
								<span class="blog-title"><%= link_to content.blog.name, blog_path(content.blog.slug) %></span> 
								<span class="pipe">|</span> 
								<time pubdate=""><%= smart_date content %></time> 
								<span class="pipe">|</span> 
								<%= render_byline content %>
							</p>
							<%= content.teaser %>
						</div>
					</div> <!-- span18/24 -->
				</div>
			</div>
		<% end %>
	<% end %>
<% end %>
</div>
<!-- /blog-entries -->


<!-- Video Shells -->
<div id="video" class="tab-pane">
<%= content_cache "archive:#{@date.to_i}:video_shells" do %>
	<h2>Video</h2>

	<%= any_to_list? @video_shells, message: "There were no videos published on this date." do %>
		<% @video_shells.each do |content| %>
			<% register_content(content) if @date == Time.now.beginning_of_day %>

			<div class="teaser cbase">
				<div class="row-fluid">
					<% if content.assets.present? %>
						<div class="span4">
							<%= render_asset content, 'thumb' %>
						</div>
						<div class="span20">
					<% else %>
						<div class="span24">
					<% end %>
						<div class="info">
							<h3><%= link_to content.short_headline, content.link_path %></h3>
							<p class="byline">
								<% if content.category.present? %>
									<span class="categories"><%= link_to content.category.category, section_path(content.category.slug) %></span> 
									<span class="pipe">|</span>
								<% end %>
								<time pubdate=""><%= content.published_at.strftime("%l:%M%P") %></time> 
								<span class="pipe">|</span> 
								<%= render_byline content %>
							</p>
							<%= content.teaser %>
						</div>
					</div> <!-- span18/24 -->
				</div>
			</div>
		<% end %>
	<% end %>
<% end %>
</div>
<!-- /video shells -->


<!-- Programs -->
<div id="programs" class="tab-pane">
<%= content_cache "archive:#{@date.to_i}:programs" do %>
	<h2>Programs</h2>
	<% (@show_episodes + @show_segments).group_by { |c| c.show.title }.each_pair do |show, contents| %>
		<h4><%= show %></h4>
		<ul>
			<% contents.each do |content| %>
				<% register_content content %>
				<li><%= content.is_a?(ShowEpisode) ? "Episode:" : "Segment:" %> <%= link_to content.headline, content.link_path %></li>
			<% end %>
		</ul>
	<% end %>
<% end %>
</div>
<!-- /video shells -->

</div> <!-- tab-content -->

<script type="text/javascript">
	// deep linking
	var query, keyval;
	var params = {};
	query = _(window.location.search.substring(1).split("&")).each(function(pair) { keyval = pair.split("="); params[keyval[0]] = keyval[1]; });
	
	tab = $("#archive_nav a[href='#"+params['section']+"']")
	if(tab) tab.tab('show');
	
	$("#archive_nav a").on({
		click: function(event) {
			target = $(event.target).attr("href").substr(1);
			if (window.history.replaceState) {
				window.history.replaceState({ section: target }, document.title + ": " + target, window.location.pathname + "?section=" + target);
			} else {
				window.location.hash = target;
			}
		}
	})
</script>

<% end %> <%# @date? %>

<hr />
<%= render '/shared/widgets/archive' %>
