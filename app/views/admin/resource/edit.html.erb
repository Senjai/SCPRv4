<% page_title "Editing: #{@record.to_title}" %>

<%= simple_form_for [:admin, @record], html: { class: "form-horizontal" } do |f| %>
	<%= render 'form_fields', record: @record, f: f %>
	<%= submit_row @record %>
<% end %>

<% content_for :sidebar do %>
	<div class="form-actions">
		<%= link_to "History", admin_history_path(@record.class.route_key, @record.id), class: "btn btn-primary" %>
		<%= link_to("Edit in Django", @record.django_edit_url, class: "btn") if @record.exists_in_django? %>
	</div>
	
	<h3>Currently Editing on This Page</h3>
	<ul id="viewers" class="viewers">
	</ul>
<% end %>

<script type="text/javascript">
	if(typeof io === "undefined") {
		$(document).ready(function() {
			$("ul#viewers").append("Newsroom Alerts are currently offline.");
		});
	} else {

		var socket = io.connect('<%= j Rails.application.config.node.server %>');
		socket.emit('entered', "<%= j admin_user.to_json.html_safe %>", "<%= j @record.to_json.html_safe %>");

		$("input, textarea").on("focus", function(event) {
			socket.emit('focus', $(event.target).attr('id'));
		});
	
		socket.on('highlight_field', function(field_id, color) {
			$("#"+field_id).closest(".control-group").css({"background-color": color});
		});
	
		$("input, textarea").on("blur", function(event) {
			socket.emit('blur', $(event.target).attr('id'));
		});

		socket.on('unhighlight_field', function(field_id) {
			console.log(field_id);
			$("#"+field_id).closest(".control-group").css({"background-color": 'white'});
		});
	
		socket.on('load_viewers', function(users) {
			_.each(users, function(user) {
		    	$('#viewers').append("<li class=\"user-badge\" id=\"user-" + user.id + "\" style=\"background-color: " + user.color + "\">" + user.name + "</li>");
			});
		});
	
		socket.on('add_viewer', function(user) {
	    	$('#viewers').append("<li class=\"user-badge\" id=\"user-" + user.id + "\" style=\"background-color: " + user.color + "\">" + user.name + "</li>");
	  	});

		socket.on('remove_viewer', function(user) {
			$("#viewers li#user-" + user.id).remove();
		});
	}
</script>